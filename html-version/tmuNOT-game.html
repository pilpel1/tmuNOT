<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tmuNOT - ××©×—×§ ×ª××•× ×•×ª</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: black;
            outline: none;
            font-family: 'Heebo', sans-serif;
        }
        
        .slide {
            display: flex;
            width: 100vw;
            height: 100vh;
            align-items: center;
            justify-content: center;
            outline: none;
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .slide.active {
            opacity: 1;
        }
        
        .slide img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        
        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 8px;
            background-color: rgba(0, 0, 0, 0.3);
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: rgba(255, 255, 255, 0.8);
            transition: none;
        }
        
        .slide-counter {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            z-index: 1500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .slide-counter.visible {
            opacity: 1;
        }
        
        /* File selection screen */
        .file-selection-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(45deg, red 50%, green 50%);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            direction: rtl;
        }
        
        .file-selection-screen.hidden {
            display: none;
        }
        
        .file-selection-title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }
        
        .file-selection-subtitle {
            font-size: 24px;
            margin-bottom: 40px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .file-input-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .file-input-button {
            background-color: rgba(255, 255, 255, 0.9);
            color: black;
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 18px;
            font-family: 'Heebo', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
        }
        
        .file-input-button:hover {
            background-color: rgba(255, 255, 255, 1);
            transform: scale(1.05);
        }
        
        .file-input {
            display: none;
        }
        
        .drop-zone {
            border: 3px dashed rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            padding: 40px;
            margin: 20px;
            background-color: rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            min-width: 400px;
        }
        
        .drop-zone.dragover {
            border-color: rgba(255, 255, 255, 1);
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .drop-zone-text {
            font-size: 20px;
            margin-bottom: 10px;
        }
        
        .drop-zone-subtext {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .selected-files-info {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .selected-files-info.visible {
            opacity: 1;
        }
        
        .start-game-button {
            background-color: rgba(76, 175, 80, 0.9);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 40px;
            font-size: 20px;
            font-family: 'Heebo', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        
        .start-game-button.visible {
            opacity: 1;
            pointer-events: all;
        }
        
        .start-game-button:hover {
            background-color: rgba(76, 175, 80, 1);
            transform: scale(1.05);
        }
        
        /* Start screen - same as before */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .start-screen.hidden {
            display: none;
        }
        
        .start-left {
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            background-color: red;
        }
        
        .start-right {
            position: absolute;
            top: 0;
            right: 0;
            width: 50%;
            height: 100%;
            background-color: green;
        }
        
        .countdown-text {
            position: relative;
            font-size: 72px;
            font-weight: bold;
            color: white;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
            z-index: 2001;
            font-family: 'Heebo', sans-serif;
            direction: rtl;
            text-align: center;
        }
        
        .settings-button {
            position: absolute;
            bottom: 30px;
            left: 30px;
            width: 50px;
            height: 50px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            z-index: 3001;
        }
        
        .settings-button:hover {
            background-color: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }
        
        .settings-panel {
            position: absolute;
            bottom: 90px;
            left: 30px;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Heebo', sans-serif;
            direction: rtl;
            text-align: right;
            z-index: 3001;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .settings-panel.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        
        .settings-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: right;
        }
        
        .setting-item {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
        }
        
        .setting-label {
            font-size: 14px;
            min-width: 100px;
        }
        
        .setting-input {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 5px;
            padding: 5px 8px;
            font-size: 14px;
            width: 60px;
            text-align: center;
            color: black;
        }
        
        .setting-select {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 5px;
            padding: 5px 8px;
            font-size: 14px;
            width: 120px;
            color: black;
            font-family: 'Heebo', sans-serif;
            cursor: pointer;
        }
        
        .save-button {
            background-color: rgba(76, 175, 80, 0.9);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 16px;
            font-size: 14px;
            font-family: 'Heebo', sans-serif;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        
        .save-button:hover {
            background-color: rgba(76, 175, 80, 1);
        }
        
        .save-button.success {
            background-color: rgba(46, 125, 50, 1);
        }
        
        /* Credits text */
        .credits-text {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 12px;
            direction: rtl;
            text-align: right;
            z-index: 3001;
            max-width: 300px;
            line-height: 1.4;
        }
        
        .credits-text a {
            color: #87CEEB;
            text-decoration: none;
        }
        
        .credits-text a:hover {
            text-decoration: underline;
        }
        
        /* Break screen - same as before */
        .break-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .break-screen.hidden {
            display: none;
        }
        
        .break-left {
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            background-color: red;
        }
        
        .break-right {
            position: absolute;
            top: 0;
            right: 0;
            width: 50%;
            height: 100%;
            background-color: green;
        }
        
        .break-content {
            position: relative;
            z-index: 2001;
            text-align: center;
            color: white;
            margin-bottom: 30px;
            direction: rtl;
            font-family: 'Heebo', sans-serif;
        }
        
        .break-title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }
        
        .break-info {
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .continue-button {
            position: relative;
            width: 120px;
            height: 120px;
            background-color: rgba(255, 255, 255, 0.9);
            border: 3px solid rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 2001;
        }
        
        .continue-button:hover {
            background-color: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }
        
        .continue-triangle {
            width: 0;
            height: 0;
            border-left: 30px solid rgba(0, 0, 0, 0.7);
            border-top: 20px solid transparent;
            border-bottom: 20px solid transparent;
            margin-left: 8px;
        }
        
        /* Completion screen */
        .completion-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .completion-screen.hidden {
            display: none;
        }
        
        .completion-left {
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            background-color: red;
        }
        
        .completion-right {
            position: absolute;
            top: 0;
            right: 0;
            width: 50%;
            height: 100%;
            background-color: green;
        }
        
        .completion-content {
            position: relative;
            z-index: 2001;
            text-align: center;
            color: white;
            margin-bottom: 30px;
            direction: rtl;
            font-family: 'Heebo', sans-serif;
        }
        
        .completion-title {
            font-size: 56px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }
        
        .completion-subtitle {
            font-size: 32px;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .completion-message {
            font-size: 20px;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            max-width: 600px;
            line-height: 1.4;
        }
        
        .restart-button {
            position: relative;
            background-color: rgba(255, 255, 255, 0.9);
            color: black;
            border: 3px solid rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px 40px;
            font-size: 24px;
            font-family: 'Heebo', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2001;
            font-weight: bold;
        }
        
        .restart-button:hover {
            background-color: rgba(255, 255, 255, 1);
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- File selection screen -->
    <div class="file-selection-screen" id="fileSelectionScreen">
        <div class="file-selection-title">tmuNOT</div>
        <div class="file-selection-subtitle">×‘×—×¨ ×ª××•× ×•×ª ×œ××©×—×§</div>
        
        <div class="file-input-container">
            <button class="file-input-button" onclick="document.getElementById('fileInput').click()">
                ğŸ“ ×‘×—×¨ ×ª××•× ×•×ª
            </button>
            <input type="file" id="fileInput" class="file-input" multiple accept="image/*">
            
            <button class="file-input-button" onclick="document.getElementById('folderInput').click()">
                ğŸ“‚ ×‘×—×¨ ×ª×™×§×™×™×ª ×ª××•× ×•×ª
            </button>
            <input type="file" id="folderInput" class="file-input" webkitdirectory accept="image/*">
        </div>
        
        <div class="drop-zone" id="dropZone">
            <div class="drop-zone-text">ğŸ–¼ï¸ ××• ×’×¨×•×¨ ×ª××•× ×•×ª ×œ×›××Ÿ</div>
            <div class="drop-zone-subtext">×ª×•××š ×‘-JPG, PNG, GIF</div>
        </div>
        
        <div class="selected-files-info" id="selectedFilesInfo">
            <div id="filesCount">0 ×ª××•× ×•×ª × ×‘×—×¨×•</div>
        </div>
        
        <button class="start-game-button" id="startGameButton">ğŸ® ×”×ª×—×œ ××©×—×§</button>
        
        <div class="settings-button" id="settingsButton">
            âš™ï¸
        </div>
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-title">×”×’×“×¨×•×ª ××©×—×§</div>
            <div class="setting-item">
                <label class="setting-label">×–××Ÿ ×œ×ª××•× ×” (×©× ×™×•×ª):</label>
                <input type="number" id="slideDuration" class="setting-input" value="4" min="1" max="30">
            </div>
            <div class="setting-item">
                <label class="setting-label">×ª××•× ×•×ª ×œ×¡×‘×‘:</label>
                <select id="breakInterval" class="setting-select">
                    <option value="5">5 ×ª××•× ×•×ª</option>
                    <option value="10" selected>10 ×ª××•× ×•×ª</option>
                    <option value="15">15 ×ª××•× ×•×ª</option>
                    <option value="20">20 ×ª××•× ×•×ª</option>
                    <option value="25">25 ×ª××•× ×•×ª</option>
                    <option value="0">×œ×œ× ×”×¤×¡×§×•×ª</option>
                </select>
            </div>
            <button class="save-button" id="saveButton">×©××•×¨ ×”×’×“×¨×•×ª</button>
        </div>
        
        <div class="credits-text">
            <strong>×–×›×•×™×•×ª ×”××©×—×§ ×©××•×¨×•×ª ×œ×“×•× ×§×™ - <a href="https://youtu.be/0VcDc3aWCDE?feature=shared&t=763" target="_blank">×—×¨×˜×˜×•× ×™</a></strong> Â©ï¸<br>
            <span style="margin-top: 5px; display: inline-block;">×¤×•×ª×— ×¢×œ ×™×“×™ <a href="https://github.com/pilpel1/tmuNOT" target="_blank">pilpel1</a></span>
        </div>
    </div>
    
    <!-- Start screen -->
    <div class="start-screen hidden" id="startScreen">
        <div class="start-left"></div>
        <div class="start-right"></div>
        <div class="countdown-text" id="countdownText">××•×›× ×™×?</div>
    </div>
    
    <!-- Progress bar -->
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    
    <!-- Slide counter -->
    <div class="slide-counter" id="slideCounter">1/0</div>
    
    <!-- Break screen -->
    <div class="break-screen hidden" id="breakScreen">
        <div class="break-left"></div>
        <div class="break-right"></div>
        <div class="break-content">
            <div class="break-title">×”×¤×¡×§×”!</div>
            <div class="break-info" id="breakInfo">×¡×‘×‘ 1 ×”×¡×ª×™×™×</div>
            <div class="break-info" id="breakProgress">×ª××•× ×•×ª 1-10 ××ª×•×š 0</div>
        </div>
        <div class="continue-button" id="continueButton">
            <div class="continue-triangle"></div>
        </div>
    </div>
    
    <!-- Completion screen -->
    <div class="completion-screen hidden" id="completionScreen">
        <div class="completion-left"></div>
        <div class="completion-right"></div>
        <div class="completion-content">
            <div class="completion-title">ğŸ‰ ××œ×•×¤×™×! ğŸ‰</div>
            <div class="completion-subtitle">××™×–×” ×›×™×£!</div>
            <p class="completion-message">×¡×™×™××ª× ××ª ×”××©×—×§!</p>
            <p class="completion-message" style="margin-top: 30px; margin-bottom: 10px;">×›×“×™ ×œ×”×ª×—×™×œ ×•×œ×‘×—×•×¨ ×ª××•× ×•×ª ××—×“×© ×œ×—×¦×• ×›××Ÿ</p>
        </div>
        <button class="restart-button" id="restartButton">ğŸ”„ ×”×ª×—×œ ××—×“×©</button>
    </div>
    
    <!-- Slides will be generated here -->
    <div id="slidesContainer"></div>
    
    <script>
        // Configuration
        let SLIDE_DURATION = 4000; // milliseconds (default)
        let BREAK_INTERVAL = 10; // slides before break (default)
        let currentSlide = 0;
        let slides = [];
        let selectedImages = [];
        
        // UI Elements
        const fileSelectionScreen = document.getElementById('fileSelectionScreen');
        const startScreen = document.getElementById('startScreen');
        const fileInput = document.getElementById('fileInput');
        const folderInput = document.getElementById('folderInput');
        const dropZone = document.getElementById('dropZone');
        const selectedFilesInfo = document.getElementById('selectedFilesInfo');
        const filesCount = document.getElementById('filesCount');
        const startGameButton = document.getElementById('startGameButton');
        const slidesContainer = document.getElementById('slidesContainer');
        const progressBar = document.getElementById('progressBar');
        const slideCounter = document.getElementById('slideCounter');
        const breakScreen = document.getElementById('breakScreen');
        const continueButton = document.getElementById('continueButton');
        const breakInfo = document.getElementById('breakInfo');
        const breakProgress = document.getElementById('breakProgress');
        const countdownText = document.getElementById('countdownText');
        const settingsButton = document.getElementById('settingsButton');
        const settingsPanel = document.getElementById('settingsPanel');
        const slideDurationInput = document.getElementById('slideDuration');
        const breakIntervalSelect = document.getElementById('breakInterval');
        const saveButton = document.getElementById('saveButton');
        const completionScreen = document.getElementById('completionScreen');
        const restartButton = document.getElementById('restartButton');
        
        // Game state
        let gameStarted = false;
        let onBreak = false;
        let settingsVisible = false;
        
        // Timer state
        let timerState = 'stopped'; // 'running', 'paused', 'stopped'
        let startTime = null;
        let pausedTime = 0;
        let animationId = null;
        
        // File handling
        function handleFiles(files) {
            selectedImages = [];
            const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length === 0) {
                alert('×œ× × ××¦××• ×ª××•× ×•×ª! ×× × ×‘×—×¨ ×§×‘×¦×™ ×ª××•× ×•×ª.');
                return;
            }
            
            let loadedCount = 0;
            imageFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedImages.push({
                        name: file.name,
                        data: e.target.result
                    });
                    loadedCount++;
                    
                    if (loadedCount === imageFiles.length) {
                        // Shuffle images
                        shuffleArray(selectedImages);
                        updateFilesInfo();
                    }
                };
                reader.readAsDataURL(file);
            });
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function updateFilesInfo() {
            filesCount.textContent = `${selectedImages.length} ×ª××•× ×•×ª × ×‘×—×¨×•`;
            selectedFilesInfo.classList.add('visible');
            startGameButton.classList.add('visible');
        }
        
        function generateSlides() {
            slidesContainer.innerHTML = '';
            slides = [];
            
            let lastColor = null;
            let colorCount = 0;
            
            selectedImages.forEach((image, index) => {
                // Prevent more than 3 consecutive same colors
                let color;
                if (colorCount >= 3) {
                    color = lastColor === 'red' ? 'green' : 'red';
                    colorCount = 1;
                } else {
                    color = Math.random() < 0.5 ? 'red' : 'green';
                    if (color === lastColor) {
                        colorCount++;
                    } else {
                        colorCount = 1;
                    }
                }
                lastColor = color;
                
                const slideDiv = document.createElement('div');
                slideDiv.className = 'slide';
                slideDiv.style.backgroundColor = color;
                
                const img = document.createElement('img');
                img.src = image.data;
                img.alt = 'Slide Image';
                
                slideDiv.appendChild(img);
                slidesContainer.appendChild(slideDiv);
                slides.push(slideDiv);
            });
            
            slideCounter.textContent = `1/${slides.length}`;
        }
        
        function showSlide(n) {
            console.log('Showing slide:', n, 'of', slides.length);
            slides.forEach((slide, index) => {
                slide.classList.remove('active');
                if (index === n) {
                    slide.classList.add('active');
                }
            });
            
            // Update slide counter
            slideCounter.textContent = `${n + 1}/${slides.length}`;
            
            if (gameStarted) {
                resetTimer();
            }
        }
        
        function startGame() {
            // Read settings from UI
            const durationValue = parseInt(slideDurationInput.value);
            const intervalValue = parseInt(breakIntervalSelect.value);
            
            // Validate and apply settings
            if (durationValue >= 1 && durationValue <= 30) {
                SLIDE_DURATION = durationValue * 1000; // convert to milliseconds
            }
            
            BREAK_INTERVAL = intervalValue; // 0 means no breaks
            
            gameStarted = true;
            startScreen.classList.add('hidden');
            slideCounter.classList.add('visible');
            showSlide(0);
        }
        
        function nextSlide() {
            if (currentSlide < slides.length - 1) {
                currentSlide++;
                showSlide(currentSlide);
                
                // Check if it's time for a break (after showing the slide)
                if (BREAK_INTERVAL > 0 && currentSlide % BREAK_INTERVAL === 0 && currentSlide < slides.length - 1) {
                    showBreakScreen();
                }
            } else {
                // We're trying to go past the last slide, show completion screen
                showCompletionScreen();
            }
        }
        
        function prevSlide() {
            if (currentSlide > 0) {
                currentSlide--;
                showSlide(currentSlide);
            }
        }
        
        function showBreakScreen() {
            onBreak = true;
            timerState = 'paused';
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            
            const roundNumber = Math.floor(currentSlide / BREAK_INTERVAL);
            const startSlide = (roundNumber - 1) * BREAK_INTERVAL + 1;
            const endSlide = roundNumber * BREAK_INTERVAL;
            
            breakInfo.textContent = `×¡×‘×‘ ${roundNumber} ×”×¡×ª×™×™×`;
            breakProgress.textContent = `×ª××•× ×•×ª ${startSlide}-${endSlide} ××ª×•×š ${slides.length}`;
            
            breakScreen.classList.remove('hidden');
        }
        
        function hideBreakScreen() {
            onBreak = false;
            breakScreen.classList.add('hidden');
            if (gameStarted && currentSlide < slides.length - 1) {
                resetTimer();
            }
        }
        
        function showCompletionScreen() {
            gameStarted = false;
            slideCounter.classList.remove('visible');
            completionScreen.classList.remove('hidden');
        }
        
        function resetGame() {
            // Reset all game state
            gameStarted = false;
            currentSlide = 0;
            slides = [];
            selectedImages = [];
            onBreak = false;
            timerState = 'stopped';
            startTime = null;
            pausedTime = 0;
            
            // Cancel any running animation
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // Reset UI elements
            progressBar.style.width = '0%';
            slideCounter.classList.remove('visible');
            slideCounter.textContent = '1/0';
            
            // Hide all screens except file selection
            completionScreen.classList.add('hidden');
            startScreen.classList.add('hidden');
            breakScreen.classList.add('hidden');
            fileSelectionScreen.classList.remove('hidden');
            
            // Reset file selection UI
            selectedFilesInfo.classList.remove('visible');
            startGameButton.classList.remove('visible');
            filesCount.textContent = '0 ×ª××•× ×•×ª × ×‘×—×¨×•';
            
            // Reset settings to default
            slideDurationInput.value = '4';
            breakIntervalSelect.value = '10';
            SLIDE_DURATION = 4000;
            BREAK_INTERVAL = 10;
            
            // Reset settings panel
            settingsPanel.classList.remove('visible');
            settingsVisible = false;
            saveButton.textContent = '×©××•×¨ ×”×’×“×¨×•×ª';
            saveButton.classList.remove('success');
            
            // Clear slides container
            slidesContainer.innerHTML = '';
        }
        
        function toggleSettings() {
            settingsVisible = !settingsVisible;
            if (settingsVisible) {
                settingsPanel.classList.add('visible');
            } else {
                settingsPanel.classList.remove('visible');
            }
        }
        
        function saveSettings() {
            const durationValue = parseInt(slideDurationInput.value);
            const intervalValue = parseInt(breakIntervalSelect.value);
            
            if (durationValue >= 1 && durationValue <= 30) {
                saveButton.textContent = 'âœ“ × ×©××¨!';
                saveButton.classList.add('success');
                
                setTimeout(() => {
                    saveButton.textContent = '×©××•×¨ ×”×’×“×¨×•×ª';
                    saveButton.classList.remove('success');
                }, 2000);
                
                setTimeout(() => {
                    toggleSettings();
                }, 1000);
            } else {
                saveButton.textContent = '×©×’×™××” - ×‘×“×•×§ ×¢×¨×›×™×';
                setTimeout(() => {
                    saveButton.textContent = '×©××•×¨ ×”×’×“×¨×•×ª';
                }, 2000);
            }
        }
        
        function resetTimer() {
            if (!gameStarted || onBreak) return;
            
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            startTime = null;
            pausedTime = 0;
            progressBar.style.width = '0%';
            
            // Start timer for all slides, including the last one
            timerState = 'running';
            setTimeout(() => {
                updateProgress();
            }, 50);
        }
        
        function pauseTimer() {
            if (timerState === 'running') {
                timerState = 'paused';
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
            }
        }
        
        function resumeTimer() {
            if (timerState === 'paused' && gameStarted && !onBreak) {
                timerState = 'running';
                updateProgress();
            }
        }
        
        function toggleTimer() {
            if (timerState === 'running') {
                pauseTimer();
            } else if (timerState === 'paused') {
                resumeTimer();
            }
        }
        
        function updateProgress() {
            if (timerState !== 'running') return;
            
            const now = Date.now();
            if (!startTime) {
                startTime = now - pausedTime;
            }
            
            const elapsed = now - startTime;
            const progress = Math.min(elapsed / SLIDE_DURATION, 1);
            
            progressBar.style.width = (progress * 100) + '%';
            
            if (progress >= 1) {
                progressBar.style.width = '100%';
                setTimeout(() => {
                    if (currentSlide < slides.length - 1) {
                        nextSlide();
                    } else {
                        // We're at the last slide, show completion screen
                        timerState = 'stopped';
                        showCompletionScreen();
                    }
                }, 50);
            } else {
                animationId = requestAnimationFrame(updateProgress);
            }
        }
        
        function manualNavigation() {
            if (!gameStarted || onBreak) return;
            pauseTimer();
            const now = Date.now();
            if (startTime) {
                pausedTime = now - startTime;
            }
        }
        
        // Event listeners
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
        
        folderInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        
        startGameButton.addEventListener('click', () => {
            generateSlides();
            fileSelectionScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            startCountdown();
        });
        
        function startCountdown() {
            const countdownSequence = ['××•×›× ×™×?', '3', '2', '1'];
            const timings = [2500, 1000, 1000, 1000]; // First item gets 2.5 seconds, rest get 1 second
            let currentIndex = 0;
            
            function showNextItem() {
                if (currentIndex < countdownSequence.length) {
                    countdownText.textContent = countdownSequence[currentIndex];
                    setTimeout(showNextItem, timings[currentIndex]);
                    currentIndex++;
                } else {
                    startGame();
                }
            }
            
            showNextItem();
        }
        
        continueButton.addEventListener('click', (e) => {
            e.stopPropagation();
            hideBreakScreen();
        });
        
        settingsButton.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleSettings();
        });
        
        saveButton.addEventListener('click', (e) => {
            e.stopPropagation();
            saveSettings();
        });
        
        settingsPanel.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        document.addEventListener('keydown', (e) => {
            console.log('Key pressed:', e.key);
            if (e.key === ' ') {
                e.preventDefault();
                if (!gameStarted) {
                    // Space key disabled during countdown/start screen
                    return;
                } else if (onBreak) {
                    hideBreakScreen();
                } else {
                    toggleTimer();
                }
            } else if (gameStarted && !onBreak) {
                if (e.key === 'ArrowRight') {
                    manualNavigation();
                    nextSlide();
                } else if (e.key === 'ArrowLeft') {
                    manualNavigation();
                    prevSlide();
                }
            }
        });
        
        document.addEventListener('click', (e) => {
            document.body.focus();
            
            if (!gameStarted || onBreak) {
                return;
            }
            
            const x = e.clientX;
            const width = window.innerWidth;
            manualNavigation();
            if (x < width / 2) {
                prevSlide();
            } else {
                nextSlide();
            }
        });
        
        restartButton.addEventListener('click', () => {
            resetGame();
        });
        
        // Make body focusable
        document.body.tabIndex = -1;
        document.body.focus();
    </script>
</body>
</html> 